<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlatPay â€” Shared Living, Sorted</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/base.css" />
  </head>
  <body>
    <div id="app">
      <div id="screens-container"></div>
    </div>

    <div id="modals-container"></div>

    <script>
      // ============================================================
      // DATA STORE
      // ============================================================
      const DB = {
        get: (key, fb = null) => {
          try {
            const v = localStorage.getItem(key);
            return v ? JSON.parse(v) : fb;
          } catch {
            return fb;
          }
        },
        set: (key, val) => localStorage.setItem(key, JSON.stringify(val)),
      };
      const USERS_KEY = "flatpay_users",
        FLATS_KEY = "flatpay_flats",
        SESSION_KEY = "flatpay_session";
      const getUsers = () => DB.get(USERS_KEY, {});
      const saveUsers = (u) => DB.set(USERS_KEY, u);
      const getFlats = () => DB.get(FLATS_KEY, {});
      const saveFlats = (f) => DB.set(FLATS_KEY, f);
      const getSession = () => DB.get(SESSION_KEY, null);
      const saveSession = (s) => DB.set(SESSION_KEY, s);
      const clearSession = () => localStorage.removeItem(SESSION_KEY);

      // ============================================================
      // STATE
      // ============================================================
      let currentUser = null,
        currentFlat = null,
        currentExpenseId = null;

      // ============================================================
      // INIT
      // ============================================================
      window.onload = async () => {
        const screensContainer = document.getElementById("screens-container");
        if (screensContainer) {
          const [
            authHtml,
            flatChoiceHtml,
            joinPendingHtml,
            createFlatHtml,
            dashboardHtml,
            accountHtml,
          ] = await Promise.all([
            fetch("/pages/Auth.html").then((r) => r.text()),
            fetch("/pages/FlatChoice.html").then((r) => r.text()),
            fetch("/pages/JoinPending.html").then((r) => r.text()),
            fetch("/pages/CreateFlat.html").then((r) => r.text()),
            fetch("/pages/Dashboard.html").then((r) => r.text()),
            fetch("/pages/Account.html").then((r) => r.text()),
          ]);
          screensContainer.insertAdjacentHTML(
            "beforeend",
            authHtml +
              flatChoiceHtml +
              joinPendingHtml +
              createFlatHtml +
              dashboardHtml +
              accountHtml,
          );
        }

        const container = document.getElementById("modals-container");
        if (container) {
          const [addExpense, expenseDetail, invite, members] =
            await Promise.all([
              fetch("/Modals/AddExpense.html").then((r) => r.text()),
              fetch("/Modals/ExpenseDetail.html").then((r) => r.text()),
              fetch("/Modals/Invite.html").then((r) => r.text()),
              fetch("/Modals/Members.html").then((r) => r.text()),
            ]);
          container.insertAdjacentHTML(
            "beforeend",
            addExpense + expenseDetail + invite + members,
          );
        }

        const sess = getSession();
        if (sess) {
          const users = getUsers();
          if (users[sess.username]) {
            currentUser = sess;
            const userData = users[sess.username];
            if (userData.pendingFlatId && !userData.flatId) {
              // Still waiting
              currentUser.pendingFlatId = userData.pendingFlatId;
              document.getElementById("pending-flat-name").textContent =
                userData.pendingFlatName || "the flat";
              showScreen("screen-join-pending");
              return;
            }
            loadCurrentFlat();
            if (currentFlat) {
              showDashboard();
              return;
            } else {
              document.getElementById("welcome-name").textContent =
                currentUser.username;
              showScreen("screen-flat-choice");
              return;
            }
          }
        }
        showScreen("screen-auth");
      };

      function loadCurrentFlat() {
        if (!currentUser) return;
        const users = getUsers();
        const flats = getFlats();
        const ud = users[currentUser.username];
        if (ud && ud.flatId) {
          currentUser.flatId = ud.flatId;
          currentFlat = flats[ud.flatId] || null;
        }
      }

      function showScreen(id) {
        document
          .querySelectorAll(".screen")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        if (id === "screen-account") showAccountScreen();
      }

      // ============================================================
      // AUTH
      // ============================================================
      function switchAuthTab(tab) {
        document.querySelectorAll("#screen-auth .tab").forEach((t, i) => {
          t.classList.toggle(
            "active",
            (i === 0 && tab === "login") || (i === 1 && tab === "register"),
          );
        });
        document.getElementById("auth-login").style.display =
          tab === "login" ? "" : "none";
        document.getElementById("auth-register").style.display =
          tab === "register" ? "" : "none";
      }

      function toggleHelp() {
        const el = document.getElementById("help-alert");
        el.style.display = el.style.display === "none" ? "block" : "none";
      }

      function doLogin() {
        const username = document
          .getElementById("login-username")
          .value.trim()
          .toLowerCase();
        const password = document.getElementById("login-password").value;
        const err = document.getElementById("login-error");
        err.style.display = "none";
        if (!username || !password) {
          showErr(err, "Please fill in all fields.");
          return;
        }
        const users = getUsers();
        if (!users[username] || users[username].password !== btoa(password)) {
          showErr(err, "Invalid username or password.");
          return;
        }
        currentUser = { username };
        saveSession(currentUser);
        const ud = users[username];
        if (ud.pendingFlatId && !ud.flatId) {
          currentUser.pendingFlatId = ud.pendingFlatId;
          document.getElementById("pending-flat-name").textContent =
            ud.pendingFlatName || "the flat";
          showScreen("screen-join-pending");
          return;
        }
        loadCurrentFlat();
        if (currentFlat) {
          showDashboard();
        } else {
          document.getElementById("welcome-name").textContent = username;
          showScreen("screen-flat-choice");
        }
      }

      function doRegister() {
        const username = document
          .getElementById("reg-username")
          .value.trim()
          .toLowerCase();
        const password = document.getElementById("reg-password").value;
        const err = document.getElementById("reg-error");
        err.style.display = "none";
        if (!username || !password) {
          showErr(err, "Please fill in all fields.");
          return;
        }
        if (username.length < 3) {
          showErr(err, "Username must be at least 3 characters.");
          return;
        }
        if (password.length < 4) {
          showErr(err, "Password must be at least 4 characters.");
          return;
        }
        const users = getUsers();
        if (users[username]) {
          showErr(err, "Username already taken.");
          return;
        }
        users[username] = { password: btoa(password), flatId: null };
        saveUsers(users);
        currentUser = { username };
        saveSession(currentUser);
        document.getElementById("welcome-name").textContent = username;
        showScreen("screen-flat-choice");
      }

      function doLogout() {
        currentUser = null;
        currentFlat = null;
        clearSession();
        showScreen("screen-auth");
      }

      // ============================================================
      // JOIN WITH APPROVAL FLOW
      // ============================================================
      function doRequestJoin() {
        const code = document
          .getElementById("invite-code-input")
          .value.trim()
          .toUpperCase();
        const room = document.getElementById("join-room-input").value.trim();
        const err = document.getElementById("join-error");
        err.style.display = "none";
        if (!code) {
          showErr(err, "Please enter an invite code.");
          return;
        }
        if (!room) {
          showErr(err, "Please enter your name or room.");
          return;
        }
        const flats = getFlats();
        const flat = Object.values(flats).find((f) => f.inviteCode === code);
        if (!flat) {
          showErr(err, "No flat found with that code.");
          return;
        }

        // Already a member?
        if (flat.members.find((m) => m.username === currentUser.username)) {
          const users = getUsers();
          users[currentUser.username].flatId = flat.id;
          users[currentUser.username].room = room;
          saveUsers(users);
          currentUser.flatId = flat.id;
          saveSession(currentUser);
          currentFlat = flat;
          showDashboard();
          return;
        }

        // Add join request
        if (!flat.joinRequests) flat.joinRequests = [];
        const existing = flat.joinRequests.find(
          (r) => r.username === currentUser.username,
        );
        if (!existing)
          flat.joinRequests.push({
            username: currentUser.username,
            room,
            requestedAt: new Date().toISOString(),
          });
        flats[flat.id] = flat;
        saveFlats(flats);

        // Mark user as pending
        const users = getUsers();
        users[currentUser.username].pendingFlatId = flat.id;
        users[currentUser.username].pendingFlatName = flat.name;
        saveUsers(users);
        currentUser.pendingFlatId = flat.id;

        document.getElementById("pending-flat-name").textContent = flat.name;
        showScreen("screen-join-pending");
      }

      function checkPendingApproval() {
        const users = getUsers();
        const ud = users[currentUser.username];
        const statusEl = document.getElementById("pending-status");
        if (ud.flatId) {
          // Approved!
          currentUser.flatId = ud.flatId;
          delete currentUser.pendingFlatId;
          saveSession(currentUser);
          loadCurrentFlat();
          showDashboard();
        } else {
          statusEl.textContent = "Still waiting for approvalâ€¦";
          setTimeout(() => (statusEl.textContent = ""), 3000);
        }
      }

      // ============================================================
      // FLAT CREATION
      // ============================================================
      function generateCode() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let code = "FLAT-";
        for (let i = 0; i < 4; i++)
          code += chars[Math.floor(Math.random() * chars.length)];
        return code;
      }

      function doCreateFlat() {
        const name = document.getElementById("flat-name-input").value.trim();
        const room = document.getElementById("flat-room-input").value.trim();
        const period = document.getElementById("flat-period-select").value;
        const err = document.getElementById("create-flat-error");
        err.style.display = "none";
        if (!name) {
          showErr(err, "Please enter a flat name.");
          return;
        }
        if (!room) {
          showErr(err, "Please enter your room/name.");
          return;
        }

        const flatId = "flat_" + Date.now();
        const flat = {
          id: flatId,
          name,
          period,
          inviteCode: generateCode(),
          members: [{ username: currentUser.username, room }],
          joinRequests: [],
          expenses: [],
        };
        const flats = getFlats();
        flats[flatId] = flat;
        saveFlats(flats);
        const users = getUsers();
        users[currentUser.username].flatId = flatId;
        users[currentUser.username].room = room;
        saveUsers(users);
        currentUser.flatId = flatId;
        saveSession(currentUser);
        currentFlat = flat;
        showDashboard();
      }

      // ============================================================
      // DASHBOARD
      // ============================================================
      function showDashboard() {
        showScreen("screen-dashboard");
        renderDashboard();
      }

      function renderDashboard() {
        if (!currentFlat) return;
        currentFlat = getFlats()[currentFlat.id];
        if (!currentFlat) return;

        // Profile button initial
        const pb = document.getElementById("profile-btn");
        pb.textContent = currentUser.username[0].toUpperCase();

        document.getElementById("hero-flat-name").textContent =
          currentFlat.name;
        document.getElementById("total-period-label").textContent =
          currentFlat.period === "weekly" ? "Weekly" : "Monthly";

        const myRoom =
          currentFlat.members.find((m) => m.username === currentUser.username)
            ?.room || currentUser.username;
        let totalRecurring = 0,
          myShare = 0;
        currentFlat.expenses
          .filter((e) => e.type === "recurring")
          .forEach((e) => {
            totalRecurring += e.amount;
            const c = (e.contributors || []).find((x) => x.person === myRoom);
            if (c) myShare += c.amount;
          });
        currentFlat.expenses
          .filter((e) => e.type === "oneoff")
          .forEach((e) => {
            const c = (e.contributors || []).find((x) => x.person === myRoom);
            if (c) myShare += c.amount;
          });

        document.getElementById("total-amount").textContent =
          "$" + totalRecurring.toFixed(2);
        document.getElementById("your-share").textContent =
          "$" + myShare.toFixed(2);

        renderExpenseList(
          "recurring-list",
          currentFlat.expenses.filter((e) => e.type === "recurring"),
        );
        renderExpenseList(
          "oneoff-list",
          currentFlat.expenses.filter((e) => e.type === "oneoff"),
        );

        // Join requests badge
        const pending = (currentFlat.joinRequests || []).length;
        ["invite-badge", "invite-badge-bottom"].forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            el.style.display = pending > 0 ? "flex" : "none";
            el.textContent = pending;
          }
        });
      }

      function getExpenseStatus(expense) {
        const total = expense.amount;
        const paid = (expense.contributors || []).reduce(
          (s, c) => s + c.amount,
          0,
        );
        if (paid === 0) {
          if (
            expense.type === "oneoff" &&
            expense.dueDate &&
            new Date(expense.dueDate) < new Date()
          )
            return "overdue";
          return "notstarted";
        }
        if (paid >= total - 0.01) return "paid";
        if (
          expense.type === "oneoff" &&
          expense.dueDate &&
          new Date(expense.dueDate) < new Date()
        )
          return "overdue";
        return "partial";
      }

      function statusLabel(s) {
        return (
          {
            paid: "âœ“ Paid",
            overdue: "âš  Overdue",
            partial: "â— Partial",
            notstarted: "â—‹ Not Started",
          }[s] || s
        );
      }

      function renderExpenseList(containerId, expenses) {
        const container = document.getElementById(containerId);
        if (!expenses.length) {
          const type = containerId.includes("recurring")
            ? "recurring"
            : "one-off";
          container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${type === "recurring" ? "ðŸ“‹" : "ðŸ§¾"}</div><div class="empty-state-text">No ${type} expenses yet.</div></div>`;
          return;
        }
        container.innerHTML = expenses
          .map((e) => {
            const status = getExpenseStatus(e);
            return `<div class="expense-item" onclick="openExpenseDetail('${e.id}')">
      <div class="expense-item-left">
        <div class="expense-item-name">${escHtml(e.name)}</div>
        <div class="expense-item-meta">${e.type === "recurring" ? e.period || currentFlat.period : e.dueDate || "one-off"} Â· ${(e.contributors || []).length} contributor${(e.contributors || []).length !== 1 ? "s" : ""}</div>
      </div>
      <div class="expense-item-right">
        <div class="expense-item-amount">$${e.amount.toFixed(2)}</div>
        <span class="status-badge status-${status}">${statusLabel(status)}</span>
      </div>
    </div>`;
          })
          .join("");
      }

      // ============================================================
      // ADD EXPENSE
      // ============================================================
      function openAddExpenseModal(type) {
        document.getElementById("add-expense-type").value = type;
        document.getElementById("modal-add-expense-title").textContent =
          type === "recurring"
            ? "Add Recurring Expense"
            : "Add One-Off Expense";
        document.getElementById("ae-period-wrap").style.display =
          type === "recurring" ? "" : "none";
        document.getElementById("ae-duedate-wrap").style.display =
          type === "oneoff" ? "" : "none";
        document.getElementById("ae-period").value = currentFlat.period;
        document.getElementById("ae-name").value = "";
        document.getElementById("ae-amount").value = "";
        document.getElementById("ae-error").style.display = "none";
        openModal("modal-add-expense");
      }

      function doAddExpense() {
        const name = document.getElementById("ae-name").value.trim();
        const amount = parseFloat(document.getElementById("ae-amount").value);
        const type = document.getElementById("add-expense-type").value;
        const err = document.getElementById("ae-error");
        err.style.display = "none";
        if (!name) {
          showErr(err, "Please enter a name.");
          return;
        }
        if (isNaN(amount) || amount <= 0) {
          showErr(err, "Please enter a valid amount.");
          return;
        }
        const expense = {
          id: "exp_" + Date.now(),
          name,
          amount,
          type,
          contributors: [],
          createdAt: new Date().toISOString(),
        };
        if (type === "recurring")
          expense.period = document.getElementById("ae-period").value;
        else
          expense.dueDate = document.getElementById("ae-duedate").value || null;
        const flats = getFlats();
        currentFlat.expenses.push(expense);
        flats[currentFlat.id] = currentFlat;
        saveFlats(flats);
        closeModal("modal-add-expense");
        renderDashboard();
      }

      // ============================================================
      // EXPENSE DETAIL
      // ============================================================
      function openExpenseDetail(expenseId) {
        currentExpenseId = expenseId;
        const expense = currentFlat.expenses.find((e) => e.id === expenseId);
        if (!expense) return;
        document.getElementById("ed-name").textContent = expense.name;
        const meta =
          expense.type === "recurring"
            ? `$${expense.amount.toFixed(2)} Â· ${expense.period || currentFlat.period}`
            : `$${expense.amount.toFixed(2)} Â· one-off${expense.dueDate ? " Â· due " + expense.dueDate : ""}`;
        document.getElementById("ed-meta").textContent = meta;
        refreshExpenseDetailUI(expense);
        const sel = document.getElementById("ec-person");
        sel.innerHTML = currentFlat.members
          .map(
            (m) =>
              `<option value="${escHtml(m.room)}">${escHtml(m.room)} (${escHtml(m.username)})</option>`,
          )
          .join("");
        document.getElementById("ec-amount").value = "";
        document.getElementById("ec-percent").value = "";
        document.getElementById("ec-error").style.display = "none";
        openModal("modal-expense-detail");
      }

      function refreshExpenseDetailUI(expense) {
        const paid = (expense.contributors || []).reduce(
          (s, c) => s + c.amount,
          0,
        );
        const pct = Math.min(100, (paid / expense.amount) * 100);
        const status = getExpenseStatus(expense);
        const statusColors = {
          paid: "var(--paid)",
          overdue: "var(--overdue)",
          partial: "var(--partial)",
          notstarted: "var(--muted)",
        };
        document.getElementById("ed-status").textContent = statusLabel(status);
        document.getElementById("ed-status").className =
          "status-badge status-" + status;
        document.getElementById("ed-progress").style.width = pct + "%";
        document.getElementById("ed-progress").style.background =
          statusColors[status] || "var(--muted)";
        document.getElementById("ed-amounts").textContent =
          `$${paid.toFixed(2)} / $${expense.amount.toFixed(2)}`;
        renderContributors(expense);
      }

      function renderContributors(expense) {
        const container = document.getElementById("ed-contributors");
        if (!expense.contributors || !expense.contributors.length) {
          container.innerHTML = `<div style="color:var(--muted); font-size:0.85rem; padding:0.75rem 0;">No contributions yet.</div>`;
          return;
        }
        container.innerHTML = expense.contributors
          .map((c) => {
            const pct = ((c.amount / expense.amount) * 100).toFixed(0);
            return `<div class="contributor-item">
      <div class="avatar-row">
        <div class="avatar">${c.person[0].toUpperCase()}</div>
        <div>
          <div class="contributor-name">${escHtml(c.person)}</div>
          <div style="font-size:0.75rem; color:var(--muted);">${pct}% of total</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <div class="contributor-amount">$${c.amount.toFixed(2)}</div>
        <button class="btn btn-ghost btn-sm" style="color:var(--overdue); padding:0.25rem 0.5rem;" onclick="removeContrib('${escHtml(c.person)}')">Ã—</button>
      </div>
    </div>`;
          })
          .join("");
      }

      function syncContribInput(changed) {
        const expense = currentFlat.expenses.find(
          (e) => e.id === currentExpenseId,
        );
        if (!expense) return;
        if (changed === "percent") {
          const pct = parseFloat(document.getElementById("ec-percent").value);
          if (!isNaN(pct))
            document.getElementById("ec-amount").value = (
              (pct / 100) *
              expense.amount
            ).toFixed(2);
        } else {
          const amt = parseFloat(document.getElementById("ec-amount").value);
          if (!isNaN(amt))
            document.getElementById("ec-percent").value = (
              (amt / expense.amount) *
              100
            ).toFixed(1);
        }
      }

      function doAddContribution() {
        const person = document.getElementById("ec-person").value;
        const amount = parseFloat(document.getElementById("ec-amount").value);
        const err = document.getElementById("ec-error");
        err.style.display = "none";
        if (!person) {
          showErr(err, "Select a person.");
          return;
        }
        if (isNaN(amount) || amount <= 0) {
          showErr(err, "Enter a valid amount.");
          return;
        }
        const flats = getFlats();
        currentFlat = flats[currentFlat.id];
        const expense = currentFlat.expenses.find(
          (e) => e.id === currentExpenseId,
        );
        if (!expense) return;
        const existing = expense.contributors.find((c) => c.person === person);
        const prevAmount = existing ? existing.amount : 0;
        const otherTotal = expense.contributors
          .filter((c) => c.person !== person)
          .reduce((s, c) => s + c.amount, 0);
        if (otherTotal + amount > expense.amount + 0.01) {
          showErr(
            err,
            `Exceeds total. Max you can add: $${(expense.amount - otherTotal).toFixed(2)}`,
          );
          return;
        }
        if (existing) existing.amount = amount;
        else expense.contributors.push({ person, amount });
        flats[currentFlat.id] = currentFlat;
        saveFlats(flats);
        document.getElementById("ec-amount").value = "";
        document.getElementById("ec-percent").value = "";
        refreshExpenseDetailUI(expense);
        renderDashboard();
      }

      function removeContrib(person) {
        const flats = getFlats();
        currentFlat = flats[currentFlat.id];
        const expense = currentFlat.expenses.find(
          (e) => e.id === currentExpenseId,
        );
        if (!expense) return;
        expense.contributors = expense.contributors.filter(
          (c) => c.person !== person,
        );
        flats[currentFlat.id] = currentFlat;
        saveFlats(flats);
        refreshExpenseDetailUI(expense);
        renderDashboard();
      }

      function doDeleteExpense() {
        if (!confirm("Delete this expense?")) return;
        const flats = getFlats();
        currentFlat = flats[currentFlat.id];
        currentFlat.expenses = currentFlat.expenses.filter(
          (e) => e.id !== currentExpenseId,
        );
        flats[currentFlat.id] = currentFlat;
        saveFlats(flats);
        closeModal("modal-expense-detail");
        renderDashboard();
      }

      // ============================================================
      // INVITE + JOIN REQUESTS
      // ============================================================
      function showInviteModal() {
        const flat = getFlats()[currentFlat.id];
        document.getElementById("invite-code-display").textContent =
          flat.inviteCode;
        document.getElementById("copy-success").style.display = "none";

        const requests = flat.joinRequests || [];
        const reqSection = document.getElementById("join-requests-section");
        const reqList = document.getElementById("join-requests-list");

        if (requests.length > 0) {
          reqSection.style.display = "block";
          reqList.innerHTML = requests
            .map(
              (r) => `
      <div class="join-request-item">
        <div>
          <div style="font-weight:600; font-size:0.9rem;">@${escHtml(r.username)}</div>
          <div style="font-size:0.78rem; color:var(--muted);">Room: ${escHtml(r.room)}</div>
        </div>
        <div style="display:flex; gap:0.5rem;">
          <button class="btn btn-sm btn-primary" onclick="approveJoin('${escHtml(r.username)}','${escHtml(r.room)}')">Approve</button>
          <button class="btn btn-sm btn-danger" onclick="denyJoin('${escHtml(r.username)}')">Deny</button>
        </div>
      </div>
    `,
            )
            .join("");
        } else {
          reqSection.style.display = "none";
        }

        openModal("modal-invite");
      }

      function approveJoin(username, room) {
        const flats = getFlats();
        const flat = flats[currentFlat.id];
        flat.joinRequests = (flat.joinRequests || []).filter(
          (r) => r.username !== username,
        );
        flat.members.push({ username, room });
        flats[flat.id] = flat;
        saveFlats(flats);
        const users = getUsers();
        if (users[username]) {
          users[username].flatId = flat.id;
          users[username].room = room;
          delete users[username].pendingFlatId;
          delete users[username].pendingFlatName;
          saveUsers(users);
        }
        currentFlat = flat;
        showInviteModal(); // refresh modal
        renderDashboard();
      }

      function denyJoin(username) {
        const flats = getFlats();
        const flat = flats[currentFlat.id];
        flat.joinRequests = (flat.joinRequests || []).filter(
          (r) => r.username !== username,
        );
        flats[flat.id] = flat;
        saveFlats(flats);
        const users = getUsers();
        if (users[username]) {
          delete users[username].pendingFlatId;
          delete users[username].pendingFlatName;
          saveUsers(users);
        }
        currentFlat = flat;
        showInviteModal();
        renderDashboard();
      }

      function copyInviteCode() {
        navigator.clipboard.writeText(currentFlat.inviteCode).then(() => {
          const el = document.getElementById("copy-success");
          el.style.display = "block";
          setTimeout(() => (el.style.display = "none"), 2000);
        });
      }

      // ============================================================
      // MEMBERS MODAL
      // ============================================================
      function showMembersModal() {
        const container = document.getElementById("members-list");
        container.innerHTML = currentFlat.members
          .map(
            (m) => `
    <div class="contributor-item">
      <div class="avatar-row">
        <div class="avatar">${m.room[0].toUpperCase()}</div>
        <div>
          <div class="contributor-name">${escHtml(m.room)}</div>
          <div style="font-size:0.75rem; color:var(--muted);">@${escHtml(m.username)}</div>
        </div>
      </div>
      ${m.username === currentUser.username ? "<span style=\"font-size:0.7rem;color:var(--accent);font-family:'DM Mono',monospace;\">you</span>" : ""}
    </div>
  `,
          )
          .join("");
        openModal("modal-members");
      }

      // ============================================================
      // ACCOUNT PAGE
      // ============================================================
      function showAccountScreen() {
        const users = getUsers();
        const ud = users[currentUser.username];
        const myRoom =
          currentFlat?.members.find((m) => m.username === currentUser.username)
            ?.room || currentUser.username;

        document.getElementById("account-avatar").textContent =
          currentUser.username[0].toUpperCase();
        document.getElementById("account-username").textContent =
          currentUser.username;
        document.getElementById("account-flat-name").textContent = currentFlat
          ? currentFlat.name
          : "No flat";
        document.getElementById("account-room").textContent = myRoom
          ? `Room: ${myRoom}`
          : "";

        if (!currentFlat) {
          document.getElementById("account-upcoming").innerHTML =
            '<p style="color:var(--muted);font-size:0.85rem;">Not in a flat yet.</p>';
          document.getElementById("account-completed").innerHTML = "";
          return;
        }

        const upcoming = [],
          completed = [];
        currentFlat.expenses.forEach((e) => {
          const myContrib = (e.contributors || []).find(
            (c) => c.person === myRoom,
          );
          if (!myContrib) return;
          const status = getExpenseStatus(e);
          const row = {
            name: e.name,
            amount: myContrib.amount,
            status,
            type: e.type,
            dueDate: e.dueDate,
            period: e.period || currentFlat.period,
          };
          if (status === "paid") completed.push(row);
          else upcoming.push(row);
        });

        const renderPaymentRow = (r) => `<div class="payment-row">
    <div>
      <div style="font-weight:500; font-size:0.9rem;">${escHtml(r.name)}</div>
      <div style="font-size:0.75rem; color:var(--muted);">${r.type === "recurring" ? r.period : r.dueDate ? "Due " + r.dueDate : "one-off"}</div>
    </div>
    <div style="display:flex; align-items:center; gap:0.75rem;">
      <span class="mono" style="font-size:0.9rem; color:var(--accent);">$${r.amount.toFixed(2)}</span>
      <span class="status-badge status-${r.status}">${statusLabel(r.status)}</span>
    </div>
  </div>`;

        document.getElementById("account-upcoming").innerHTML = upcoming.length
          ? upcoming.map(renderPaymentRow).join("")
          : '<p style="color:var(--muted);font-size:0.85rem;padding:0.5rem 0;">No upcoming payments â€” you\'re all good! ðŸŽ‰</p>';

        document.getElementById("account-completed").innerHTML =
          completed.length
            ? completed.map(renderPaymentRow).join("")
            : '<p style="color:var(--muted);font-size:0.85rem;padding:0.5rem 0;">No completed payments yet.</p>';
      }

      // ============================================================
      // MODAL HELPERS
      // ============================================================
      function openModal(id) {
        document.getElementById(id).classList.add("open");
      }
      function closeModal(id) {
        document.getElementById(id).classList.remove("open");
      }
      function closeModalIfOutside(e, id) {
        if (e.target.id === id) closeModal(id);
      }

      // ============================================================
      // UTILS
      // ============================================================
      function showErr(el, msg) {
        el.textContent = msg;
        el.style.display = "block";
      }
      function escHtml(s) {
        return String(s)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }
    </script>
  </body>
</html>
